<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2ë²ˆ ë„êµ¬ - ì…ì°° ìë™ ê³„ì‚°ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      padding: 16px;
      background-color: #f4f4f7;
      color: #222;
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    .app-container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .section {
      margin-bottom: 20px;
      padding: 16px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .section-header h2 {
      font-size: 1rem;
      margin: 0;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
      background: #fff;
    }
    input:focus,
    select:focus,
    textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
    }
    .grid {
      display: grid;
      gap: 12px;
    }
    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.1s ease;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.outline {
      background: transparent;
      border: 1px solid #d1d5db;
      color: #111827;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    button:not(:disabled):hover {
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }
    .badge.success {
      background: #ecfdf3;
      border-color: #bbf7d0;
      color: #15803d;
    }
    .badge.warn {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #c2410c;
    }
    .text-small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .text-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .result-highlight {
      font-size: 1.2rem;
      font-weight: 700;
      margin: 4px 0 2px;
    }
    .result-sub {
      font-size: 0.9rem;
      color: #4b5563;
    }
    .error-msg {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #b91c1c;
    }
    .log-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 0.8rem;
    }
    .log-table th,
    .log-table td {
      border: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: left;
      white-space: nowrap;
    }
    .log-table th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .pill {
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 0.75rem;
      background: #eef2ff;
      color: #4338ca;
      display: inline-block;
    }
    .footer-note {
      margin-top: 12px;
      font-size: 0.75rem;
      color: #9ca3af;
      text-align: right;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <h1>2ë²ˆ ë„êµ¬ â€“ ì…ì°° ìë™ ê³„ì‚°/ê¸°ë¡ ë„êµ¬</h1>
    <p class="text-small">
      ì´ í™”ë©´ì€ <strong>ì…ì°° ê³µê³  1ê±´ ì…ë ¥ â†’ ì¡°ê±´ 1ê°œ ë¶„ì„ â†’ ê²°ê³¼ 1ê°œ ì¶œë ¥</strong>ì„ ê¸°ë³¸ ì„¸íŠ¸ë¡œ ë™ì‘í•˜ë©°,  
      í™”ë©´ì— ë³´ì´ëŠ” ìš”ì†Œë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </p>

    <!-- ì…ë ¥ êµ¬ì—­ -->
    <section class="section" id="section-input">
      <div class="section-header">
        <h2>â‘  ì…ì°° ì •ë³´ ì…ë ¥</h2>
        <span class="badge">ì…ë ¥ ì˜ì—­</span>
      </div>
      <div class="grid grid-2">
        <div>
          <label for="orgSelect">ê¸°ê´€ ì„ íƒ</label>
          <select id="orgSelect">
            <option value="ë‚˜ë¼ì¥í„°">ë‚˜ë¼ì¥í„°</option>
            <option value="KISTI">KISTI</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div>
          <label for="bidNo">ê³µê³ ë²ˆí˜¸</label>
          <input type="text" id="bidNo" placeholder="ì˜ˆ: 20251234-001" />
        </div>
        <div>
          <label for="expectedPrice">ì˜ˆì •ê°€ê²© (ì›)</label>
          <input type="number" id="expectedPrice" min="0" step="1" placeholder="ì˜ˆ: 100000000" />
        </div>
        <div>
          <label for="rate">ë‚™ì°°í•˜í•œìœ¨ (%)</label>
          <input type="number" id="rate" min="0" max="100" step="0.001" placeholder="ì˜ˆ: 87.745" />
        </div>
      </div>
      <div class="grid grid-2" style="margin-top: 10px;">
        <div>
          <label for="closingDate">ì…ì°° ë§ˆê°ì¼</label>
          <input type="date" id="closingDate" />
        </div>
        <div>
          <label for="memo">ë‚´ë¶€ ë©”ëª¨(ì„ íƒ)</label>
          <input type="text" id="memo" placeholder="ì˜ˆ: â—‹â—‹ì‚¬ì—… ì…ì°°, í˜‘ìƒê³„ì•½" />
        </div>
      </div>
      <div class="btn-row">
        <button id="btnCalc">
          âœ¨ ì…ì°° ê³„ì‚° ì‹¤í–‰
        </button>
        <button id="btnClear" class="secondary" type="button">
          ğŸ” ì´ˆê¸°í™”
        </button>
      </div>
      <div class="error-msg" id="inputError"></div>
    </section>

    <!-- ê²°ê³¼ êµ¬ì—­ -->
    <section class="section" id="section-result">
      <div class="section-header">
        <h2>â‘¡ ê³„ì‚° ê²°ê³¼ / ì•ˆë‚´</h2>
        <span class="badge success" id="statusBadge">ëŒ€ê¸° ì¤‘</span>
      </div>
      <div id="resultBox">
        <p class="text-small">ì…ì°° ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <strong>â€œì…ì°° ê³„ì‚° ì‹¤í–‰â€</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</p>
      </div>
      <div class="btn-row">
        <button id="btnSave" class="secondary" type="button" disabled>
          ğŸ’¾ ì´ë²ˆ ê²°ê³¼ ì €ì¥
        </button>
        <button id="btnDownload" class="outline" type="button" disabled>
          ğŸ“„ ì‚°ì¶œ ë‚´ì—­ í…ìŠ¤íŠ¸ ë‹¤ìš´ë¡œë“œ
        </button>
      </div>
    </section>

    <!-- ë¡œê·¸ êµ¬ì—­ -->
    <section class="section" id="section-log">
      <div class="section-header">
        <h2>â‘¢ ìµœê·¼ ê³„ì‚° ë¡œê·¸</h2>
        <span class="badge warn">í™”ë©´ í‘œì‹œìš© ë¡œê·¸</span>
      </div>
      <p class="text-small">
        ì´ í‘œëŠ” <strong>ì´ í™”ë©´ì—ì„œë§Œ</strong> ë³´ì´ëŠ” ê°„ë‹¨í•œ ë¡œê·¸ì…ë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
      </p>
      <div id="logWrapper">
        <p class="text-small">ì•„ì§ ì €ì¥ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>
    </section>

    <div class="footer-note">
      2ë²ˆ ë„êµ¬ â€“ ì…ì°° ìë™í™” í™”ë©´ (ì…ì°° ê³µê³  1ê±´ ê¸°ì¤€)
    </div>
  </div>

  <script>
    (function () {
      const orgSelect = document.getElementById("orgSelect");
      const bidNoInput = document.getElementById("bidNo");
      const expectedPriceInput = document.getElementById("expectedPrice");
      const rateInput = document.getElementById("rate");
      const closingDateInput = document.getElementById("closingDate");
      const memoInput = document.getElementById("memo");

      const btnCalc = document.getElementById("btnCalc");
      const btnClear = document.getElementById("btnClear");
      const btnSave = document.getElementById("btnSave");
      const btnDownload = document.getElementById("btnDownload");

      const inputError = document.getElementById("inputError");
      const resultBox = document.getElementById("resultBox");
      const statusBadge = document.getElementById("statusBadge");
      const logWrapper = document.getElementById("logWrapper");

      /** ë‚´ë¶€ ìƒíƒœ (í™”ë©´ í‘œì‹œìš©) */
      let lastResult = null;
      let logs = [];

      function formatNumber(value) {
        if (value === null || value === undefined || isNaN(value)) return "";
        return value.toLocaleString("ko-KR");
      }

      function setStatus(text, type) {
        statusBadge.textContent = text;
        statusBadge.classList.remove("success", "warn");
        if (type === "success") statusBadge.classList.add("success");
        if (type === "warn") statusBadge.classList.add("warn");
      }

      function validateInputs() {
        inputError.textContent = "";
        const errors = [];

        const org = orgSelect.value;
        const bidNo = bidNoInput.value.trim();
        const expectedRaw = expectedPriceInput.value;
        const rateRaw = rateInput.value;

        if (!org) errors.push("ê¸°ê´€ì„ ì„ íƒí•˜ì„¸ìš”.");
        if (!bidNo) errors.push("ê³µê³ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const expected = Number(expectedRaw);
        if (!expectedRaw || isNaN(expected) || expected <= 0) {
          errors.push("ì˜ˆì •ê°€ê²©ì„ 0ë³´ë‹¤ í° ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
        }

        const rate = Number(rateRaw);
        if (!rateRaw || isNaN(rate) || rate <= 0 || rate > 100) {
          errors.push("ë‚™ì°°í•˜í•œìœ¨(%)ì„ 0~100 ì‚¬ì´ì˜ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
        }

        if (errors.length > 0) {
          inputError.textContent = errors.join(" ");
          setStatus("ì…ë ¥ ì˜¤ë¥˜", "warn");
          return null;
        }

        return {
          org,
          bidNo,
          expected,
          rate,
          closingDate: closingDateInput.value || "",
          memo: memoInput.value.trim()
        };
      }

      function renderResult(result) {
        const {
          org,
          bidNo,
          expected,
          rate,
          bidPrice,
          closingDate,
          memo
        } = result;

        const orgText = org || "-";
        const closingText = closingDate || "ë¯¸ì…ë ¥";
        const memoText = memo || "ì—†ìŒ";

        resultBox.innerHTML = `
          <div>
            <div class="result-highlight text-mono">
              ì¶”ì²œ ì…ì°°ê°€: ${formatNumber(bidPrice)} ì›
            </div>
            <div class="result-sub">
              ê¸°ê´€: <span class="pill">${orgText}</span> Â·
              ê³µê³ ë²ˆí˜¸: <span class="text-mono">${bidNo}</span><br/>
              ì˜ˆì •ê°€ê²©: <span class="text-mono">${formatNumber(expected)} ì›</span> Â·
              ë‚™ì°°í•˜í•œìœ¨: <span class="text-mono">${rate}%</span><br/>
              ë§ˆê°ì¼: <span class="text-mono">${closingText}</span><br/>
              ë©”ëª¨: <span class="text-mono">${memoText}</span>
            </div>
          </div>
        `;
      }

      function renderLogs() {
        if (!logs.length) {
          logWrapper.innerHTML = '<p class="text-small">ì•„ì§ ì €ì¥ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const rows = logs.map((log, index) => {
          return `
            <tr>
              <td>${index + 1}</td>
              <td>${log.time}</td>
              <td>${log.org}</td>
              <td>${log.bidNo}</td>
              <td class="text-mono">${formatNumber(log.expected)}</td>
              <td class="text-mono">${log.rate}%</td>
              <td class="text-mono">${formatNumber(log.bidPrice)}</td>
            </tr>
          `;
        }).join("");

        logWrapper.innerHTML = `
          <table class="log-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ì‹œê°„</th>
                <th>ê¸°ê´€</th>
                <th>ê³µê³ ë²ˆí˜¸</th>
                <th>ì˜ˆì •ê°€ê²©</th>
                <th>í•˜í•œìœ¨</th>
                <th>ì¶”ì²œ ì…ì°°ê°€</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        `;
      }

      function buildTextReport(result) {
        const lines = [];
        const now = new Date();
        lines.push("[ì…ì°°ê°€ ì‚°ì¶œ ë‚´ì—­]");
        lines.push("");
        lines.push("- ìƒì„± ì‹œê°: " + now.toLocaleString("ko-KR"));
        lines.push("");
        lines.push("1. ê¸°ë³¸ ì •ë³´");
        lines.push("   Â· ê¸°ê´€: " + result.org);
        lines.push("   Â· ê³µê³ ë²ˆí˜¸: " + result.bidNo);
        lines.push("   Â· ì…ì°° ë§ˆê°ì¼: " + (result.closingDate || "ë¯¸ì…ë ¥"));
        lines.push("   Â· ë©”ëª¨: " + (result.memo || "ì—†ìŒ"));
        lines.push("");
        lines.push("2. ê¸ˆì•¡ ì •ë³´");
        lines.push("   Â· ì˜ˆì •ê°€ê²©: " + formatNumber(result.expected) + " ì›");
        lines.push("   Â· ë‚™ì°°í•˜í•œìœ¨: " + result.rate + " %");
        lines.push("   Â· ì¶”ì²œ ì…ì°°ê°€: " + formatNumber(result.bidPrice) + " ì›");
        lines.push("");
        lines.push("3. ì‚°ì‹");
        lines.push("   ì¶”ì²œ ì…ì°°ê°€ = ì˜ˆì •ê°€ê²© Ã— (ë‚™ì°°í•˜í•œìœ¨ Ã· 100)");
        lines.push("");
        lines.push("[ì°¸ê³ ] ì´ íŒŒì¼ì€ 2ë²ˆ ë„êµ¬(ì…ì°° ìë™ ê³„ì‚°ê¸°)ì—ì„œ ìë™ ìƒì„±ëœ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.");

        return lines.join("\r\n");
      }

      function handleCalculate() {
        const input = validateInputs();
        if (!input) {
          lastResult = null;
          btnSave.disabled = true;
          btnDownload.disabled = true;
          return;
        }

        // ê¸°ë³¸ ì‚°ì‹: ì˜ˆì •ê°€ê²© Ã— (í•˜í•œìœ¨ / 100)
        const bidPrice = Math.round(input.expected * (input.rate / 100));

        const result = {
          org: input.org,
          bidNo: input.bidNo,
          expected: input.expected,
          rate: input.rate,
          bidPrice,
          closingDate: input.closingDate,
          memo: input.memo
        };

        lastResult = result;
        renderResult(result);
        setStatus("ê³„ì‚° ì™„ë£Œ", "success");
        btnSave.disabled = false;
        btnDownload.disabled = false;
      }

      function handleClear() {
        orgSelect.value = "ë‚˜ë¼ì¥í„°";
        bidNoInput.value = "";
        expectedPriceInput.value = "";
        rateInput.value = "";
        closingDateInput.value = "";
        memoInput.value = "";
        inputError.textContent = "";
        resultBox.innerHTML = '<p class="text-small">ì…ì°° ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <strong>â€œì…ì°° ê³„ì‚° ì‹¤í–‰â€</strong> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤.</p>';
        setStatus("ëŒ€ê¸° ì¤‘", "");
        lastResult = null;
        btnSave.disabled = true;
        btnDownload.disabled = true;
      }

      function handleSave() {
        if (!lastResult) return;
        const now = new Date();
        const timeStr = now.toLocaleTimeString("ko-KR", { hour12: false });
        logs.unshift({
          time: timeStr,
          org: lastResult.org,
          bidNo: lastResult.bidNo,
          expected: lastResult.expected,
          rate: lastResult.rate,
          bidPrice: lastResult.bidPrice
        });
        if (logs.length > 20) {
          logs = logs.slice(0, 20);
        }
        renderLogs();
      }

      function handleDownload() {
        if (!lastResult) return;
        const text = buildTextReport(lastResult);
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);

        const safeBidNo = (lastResult.bidNo || "bid").replace(/[^\w\-]+/g, "_");
        const fileName = `ì…ì°°_ì‚°ì¶œë‚´ì—­_${safeBidNo}.txt`;

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      btnCalc.addEventListener("click", handleCalculate);
      btnClear.addEventListener("click", handleClear);
      btnSave.addEventListener("click", handleSave);
      btnDownload.addEventListener("click", handleDownload);

      renderLogs();
    })();
  </script>
</body>
</html>
