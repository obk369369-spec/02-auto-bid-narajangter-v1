<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>입찰도구 v2 – 예정가격·예비가격·하한가 시각화</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      background:#f3f4f6;
      color:#111827;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 12px;
    }
    h2 {
      font-size: 18px;
      margin: 24px 0 8px;
    }
    .card {
      background:#ffffff;
      border-radius: 10px;
      padding:16px 18px 18px;
      box-shadow:0 4px 10px rgba(15,23,42,0.06);
      margin-bottom: 18px;
    }
    .section-title {
      font-weight:600;
      margin-bottom: 10px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .section-title span.step {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      background:#2563eb;
      color:white;
      font-size:13px;
      font-weight:700;
    }
    .grid-2 {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(260px,1fr));
      gap: 10px 18px;
    }
    label {
      font-size:13px;
      font-weight:500;
      display:block;
      margin-bottom:4px;
    }
    input[type="text"], input[type="number"] {
      width:100%;
      padding:7px 9px;
      border-radius:7px;
      border:1px solid #d1d5db;
      font-size:13px;
    }
    input:focus {
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.3);
    }
    small {
      display:block;
      font-size:11px;
      color:#6b7280;
      margin-top:2px;
    }
    button {
      padding:8px 16px;
      border-radius:999px;
      border:none;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      background:#2563eb;
      color:white;
    }
    button:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:right;
      white-space:nowrap;
    }
    th {
      background:#f9fafb;
      font-weight:600;
      color:#374151;
    }
    th:first-child, td:first-child {
      text-align:left;
    }
    .summary-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap:10px 14px;
      margin-top:6px;
    }
    .summary-item {
      padding:8px 10px;
      border-radius:8px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:13px;
    }
    .summary-label {
      font-size:11px;
      color:#6b7280;
      margin-bottom:2px;
    }
    .summary-value {
      font-weight:600;
    }
    .badge {
      display:inline-flex;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
    }
    .badge-safe   { background:#dcfce7; color:#166534; }
    .badge-warn   { background:#fef9c3; color:#854d0e; }
    .badge-danger { background:#fee2e2; color:#b91c1c; }
    .bar-wrap {
      width:120px;
      background:#e5e7eb;
      border-radius:999px;
      overflow:hidden;
      height:8px;
      margin-left:auto;
    }
    .bar-inner {
      height:100%;
    }
    .bar-safe   { background:#22c55e; }
    .bar-warn   { background:#fbbf24; }
    .bar-danger { background:#ef4444; }
    .note {
      font-size:11px;
      color:#6b7280;
      margin-top:6px;
      line-height:1.4;
    }
    #autoExplain {
      font-size:13px;
      line-height:1.5;
    }
    #autoExplain p { margin:4px 0; }
    #autoExplain ul {
      margin:4px 0 4px 18px;
      padding:0;
    }
    #autoExplain li { margin:2px 0; }
    .highlight {
      font-weight:600;
      color:#2563eb;
    }
    .margin-warn { color:#b91c1c; font-weight:600; }
    .margin-ok   { color:#166534; font-weight:600; }
    @media (max-width:640px){
      h1 { font-size:18px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>입찰도구 v2 – 예정가격·예비가격 15개·낙찰하한가 시각화</h1>

    <!-- 1. 기본 값 입력 -->
    <div class="card">
      <div class="section-title">
        <span class="step">1</span>
        기본 값 입력
      </div>
      <div class="grid-2">
        <div>
          <label>예정가격 (부가세 제외, ₩)</label>
          <input id="inputEstimated" type="text" placeholder="예: 7600000" />
          <small>배정예산을 모를 때 사용. 예정가격 또는 배정예산 둘 중 하나만 넣어도 됩니다.</small>
        </div>
        <div>
          <label>배정예산 (부가세 포함, ₩)</label>
          <input id="inputBudget" type="text" placeholder="예: 8360000" />
          <small>예정가격을 모를 때 사용. 부가세를 제외해 예정가격을 근사 계산합니다.</small>
        </div>
        <div>
          <label>부가세율 (%)</label>
          <input id="inputVat" type="number" value="10" step="0.1" />
        </div>
        <div>
          <label>낙찰하한율 (%)</label>
          <input id="inputLimitRate" type="number" value="87.745" step="0.001" />
          <small>예: 87.745 → 예정가격 × 0.87745 가 하한가.</small>
        </div>
        <div>
          <label>예비가격 ±변동 범위 (%)</label>
          <input id="inputRange" type="number" value="2" step="0.1" />
          <small>예: 2 → 예정가격 기준 -2% ~ +2% 구간에서 15개 예비가격 생성.</small>
        </div>
        <div>
          <label>추천 투찰율 목록 (%) (쉼표로 구분)</label>
          <input id="inputBidRates" type="text"
                 value="100,99.7,99.5,99,98.7,98.5,98,97.5,97" />
          <small>예: 100,99.7,99.5 …</small>
        </div>
      </div>
      <div style="margin-top:12px;">
        <button id="btnCalc">계산 실행</button>
      </div>
      <div class="note">
        ※ 예정가격과 배정예산을 동시에 입력하면, <b>예정가격 입력값</b>을 우선 사용합니다.
      </div>
    </div>

    <!-- 2. 계산 결과 요약 -->
    <div class="card">
      <div class="section-title">
        <span class="step">2</span>
        계산 결과 요약
      </div>
      <div id="summaryArea" class="summary-grid">
        <!-- JS로 채움 -->
      </div>
      <div class="note">
        ▪ <b>배정예산</b>: 발주기관이 이 건에 배정한 총 예산 (부가세 포함).<br/>
        ▪ <b>예정가격</b>: 예비가격 15개 중 4개를 뽑아 평균낸 값. 여기서는 근사값으로 사용합니다.<br/>
        ▪ <b>낙찰하한가</b>: 예정가격 × 낙찰하한율. 이 금액 미만으로는 낙찰될 수 없습니다.
      </div>
    </div>

    <!-- 3. 예비가격 15개 시뮬레이션 -->
    <div class="card">
      <div class="section-title">
        <span class="step">3</span>
        예비가격 15개 (시뮬레이션)
      </div>
      <div style="overflow-x:auto;">
        <table id="tablePrePrices">
          <thead>
            <tr>
              <th>No.</th>
              <th>예비가격 (₩)</th>
              <th>예정가격 대비 (%)</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS로 채움 -->
          </tbody>
        </table>
      </div>
      <div class="note">
        실제 나라장터에서는 이 15개 중 4개를 무작위 선택하여 <b>예정가격</b>을 결정합니다.
        여기서는 분포와 범위를 이해하기 위한 참고용 시뮬레이션입니다.
      </div>
    </div>

    <!-- 4. 투찰율별 입찰금액 비교 -->
    <div class="card">
      <div class="section-title">
        <span class="step">4</span>
        투찰율별 입찰금액 비교
      </div>
      <div style="overflow-x:auto;">
        <table id="tableBids">
          <thead>
            <tr>
              <th>투찰율 (%)</th>
              <th>입찰금액 (₩)</th>
              <th>하한가 대비 (%)</th>
              <th>판단</th>
              <th>안전도 시각화</th>
            </tr>
          </thead>
          <tbody>
            <!-- JS로 채움 -->
          </tbody>
        </table>
      </div>
      <div class="note">
        ▪ <span class="badge badge-safe">초록</span> : 하한가 대비 약 0~3% 위 (일반적으로 많이 선택되는 안정 구간).<br/>
        ▪ <span class="badge badge-warn">노랑</span> : 여유는 있지만 경쟁사보다 너무 높은 구간일 수 있습니다.<br/>
        ▪ <span class="badge badge-danger">빨강</span> : 하한가 미만 또는 지나치게 높은 구간 – 주의 필요.
      </div>
    </div>

    <!-- 5. 우리 마진 계산 -->
    <div class="card">
      <div class="section-title">
        <span class="step">5</span>
        우리 마진 계산 (보고서 사업용)
      </div>
      <div class="grid-2">
        <div>
          <label>마진 계산에 사용할 투찰율 (%)</label>
          <input id="inputMarginRate" type="number" step="0.01" placeholder="예: 98.7" />
          <small>위 투찰율 표에서 선택한 값과 동일하게 입력.</small>
        </div>
        <div>
          <label>보고서 정가 합계 (부가세 포함, ₩)</label>
          <input id="inputBookPrice" type="text" placeholder="예: 9000000" />
          <small>출판사에서 제시한 보고서 묶음 정가의 합계.</small>
        </div>
        <div>
          <label>우리 커미션율 (%)</label>
          <input id="inputCommission" type="number" step="0.1" placeholder="예: 30" />
          <small>정가에서 우리가 가져가는 비율. 예: 30% → 정가의 30%가 우리 몫.</small>
        </div>
      </div>
      <div style="margin-top:10px;">
        <button id="btnMargin">마진 계산</button>
      </div>
      <div id="marginResult" class="summary-grid" style="margin-top:8px;">
        <!-- JS로 채움 -->
      </div>
      <div class="note">
        우리는 면세사업자이므로, 기관에 청구하는 <b>입찰가(부가세 포함)</b>에서
        출판사에 지급하는 금액을 뺀 값이 실질적으로 남는 마진이라고 보고 계산합니다.
      </div>
    </div>

    <!-- 6. 자동 해석 -->
    <div class="card">
      <div class="section-title">
        <span class="step">6</span>
        자동 해석
      </div>
      <div id="autoExplain">
        아직 계산 전입니다. 위에서 값을 입력하고 <b>계산 실행</b>을 눌러주세요.
      </div>
    </div>
  </div>

  <script>
    function parseNumber(str) {
      if (!str) return NaN;
      return Number(String(str).replace(/,/g, "").trim());
    }

    function formatCurrency(n) {
      if (isNaN(n)) return "-";
      return n.toLocaleString("ko-KR", { maximumFractionDigits: 0 });
    }

    function formatPercent(n, digits = 3) {
      if (isNaN(n)) return "-";
      return n.toFixed(digits);
    }

    function classifySafety(diffPercent) {
      // diffPercent: 하한가 대비 (입찰가 / 하한가 - 1) * 100
      if (diffPercent < 0) return { label: "하한가 미만 (낙찰 불가)", badge:"danger", bar:"danger" };
      if (diffPercent <= 3) return { label: "하한가 인근 (안정 구간)", badge:"safe", bar:"safe" };
      if (diffPercent <= 7) return { label: "다소 여유 (경쟁사 대비 높을 수 있음)", badge:"warn", bar:"warn" };
      return { label: "여유가 큼 (낙찰 확률↓)", badge:"warn", bar:"warn" };
    }

    let lastEstimated = NaN;
    let lastLimitPrice = NaN;
    let lastBidRows = [];

    function runCalc() {
      const estimatedInput = parseNumber(document.getElementById("inputEstimated").value);
      const budgetInput    = parseNumber(document.getElementById("inputBudget").value);
      const vatRate        = Number(document.getElementById("inputVat").value) || 0;
      const limitRate      = Number(document.getElementById("inputLimitRate").value) || 0;
      const range          = Number(document.getElementById("inputRange").value) || 0;
      const bidRatesStr    = document.getElementById("inputBidRates").value || "";

      let estimated = NaN;
      let usedBudget = NaN;

      if (!isNaN(estimatedInput)) {
        estimated = estimatedInput;
      } else if (!isNaN(budgetInput)) {
        usedBudget = budgetInput;
        const divisor = 1 + vatRate / 100;
        estimated = budgetInput / divisor;
      }

      if (!isNaN(estimated)) {
        lastEstimated = estimated;
      } else {
        alert("예정가격 또는 배정예산 중 하나는 반드시 입력해야 합니다.");
        return;
      }
      if (isNaN(usedBudget) && !isNaN(budgetInput)) {
        usedBudget = budgetInput;
      }

      const limitPrice = estimated * (limitRate / 100);
      lastLimitPrice = limitPrice;

      // 요약 영역
      const minPre = estimated * (1 - range / 100);
      const maxPre = estimated * (1 + range / 100);

      const summaryArea = document.getElementById("summaryArea");
      summaryArea.innerHTML = "";
      const items = [
        { label:"사용된 예정가격 (부가세 제외)", value: formatCurrency(Math.round(estimated)) + " 원" },
        { label:"입력한 배정예산 (부가세 포함)", value: isNaN(usedBudget) ? "입력 안함" : formatCurrency(Math.round(usedBudget)) + " 원" },
        { label:"낙찰하한가", value: formatCurrency(Math.round(limitPrice)) + " 원" },
        { label:"예비가격 범위 (근사)", value: formatCurrency(Math.round(minPre)) + " ~ " + formatCurrency(Math.round(maxPre)) + " 원" }
      ];
      items.forEach(it => {
        const div = document.createElement("div");
        div.className = "summary-item";
        div.innerHTML = '<div class="summary-label">' + it.label + '</div>' +
                        '<div class="summary-value">' + it.value + '</div>';
        summaryArea.appendChild(div);
      });

      // 예비가격 15개
      const tbodyPre = document.querySelector("#tablePrePrices tbody");
      tbodyPre.innerHTML = "";
      const rowsPre = [];
      if (range > 0) {
        for (let i = 0; i < 15; i++) {
          const ratio = -range + (2 * range) * (i / 14); // -range ~ +range
          const price = estimated * (1 + ratio / 100);
          rowsPre.push({ idx:i+1, price, diff:ratio });
        }
      }
      rowsPre.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + r.idx + "</td>" +
          "<td>" + formatCurrency(Math.round(r.price)) + "</td>" +
          "<td>" + formatPercent(r.diff, 3) + " %</td>";
        tbodyPre.appendChild(tr);
      });

      // 투찰율별 입찰금액
      const tbodyBid = document.querySelector("#tableBids tbody");
      tbodyBid.innerHTML = "";
      lastBidRows = [];
      const rateTokens = bidRatesStr.split(",").map(s => s.trim()).filter(s => s.length>0);
      rateTokens.forEach(token => {
        const rate = Number(token);
        if (isNaN(rate)) return;
        const bidPrice = estimated * (rate / 100);
        const diffPercent = (bidPrice / limitPrice - 1) * 100;
        const info = classifySafety(diffPercent);
        const barWidth = Math.min(100, Math.abs(diffPercent)); // 최대 100%
        const tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + formatPercent(rate, 3) + "</td>" +
          "<td>" + formatCurrency(Math.round(bidPrice)) + "</td>" +
          "<td>" + formatPercent(diffPercent, 3) + " %</td>" +
          '<td><span class="badge badge-' + info.badge + '">' + info.label + "</span></td>" +
          '<td><div class="bar-wrap"><div class="bar-inner bar-' + info.bar +
          '" style="width:' + barWidth + '%"></div></div></td>';
        tbodyBid.appendChild(tr);
        lastBidRows.push({
          rate,
          bidPrice,
          diffPercent,
          info
        });
      });

      updateAutoExplain();
    }

    function updateAutoExplain() {
      const area = document.getElementById("autoExplain");
      if (!lastEstimated || !lastLimitPrice || lastBidRows.length === 0) {
        area.innerHTML = "계산 결과가 아직 없습니다. 위에서 값을 입력하고 <b>계산 실행</b>을 눌러주세요.";
        return;
      }

      // 안전 구간: 하한가 대비 0~3% 위
      const safeCandidates = lastBidRows.filter(r => r.diffPercent >= 0 && r.diffPercent <= 3);
      // 너무 위험(하한가 미만)
      const dangerCandidates = lastBidRows.filter(r => r.diffPercent < 0);
      // 상단 여유 구간
      const highCandidates = lastBidRows.filter(r => r.diffPercent > 3);

      const bestSafe = safeCandidates.sort((a,b)=>Math.abs(a.diffPercent-1.5)-Math.abs(b.diffPercent-1.5))[0];
      const bestHigh = highCandidates.sort((a,b)=>a.diffPercent-b.diffPercent)[0];

      let html = "";
      html += "<p>이번 입력값으로 계산된 <span class=\"highlight\">핵심 지표</span>는 다음과 같습니다.</p>";
      html += "<ul>";
      html += "<li>예정가격(근사): <b>" + formatCurrency(Math.round(lastEstimated)) + " 원</b></li>";
      html += "<li>낙찰하한가: <b>" + formatCurrency(Math.round(lastLimitPrice)) + " 원</b></li>";
      html += "</ul>";

      if (bestSafe) {
        html += "<p>하한가 대비 0~3% 구간(안정 구간) 중에서, 가장 균형 잡힌 후보는</p>";
        html += "<ul><li>투찰율 <b>" + formatPercent(bestSafe.rate,3) + " %</b> (하한가 대비 " +
                formatPercent(bestSafe.diffPercent,3) + " %) 입니다.</li></ul>";
      } else {
        html += "<p>이번에 입력한 투찰율 목록에는 <b>하한가 대비 0~3% 구간</b>이 포함되지 않았습니다.</p>";
      }

      if (dangerCandidates.length > 0) {
        const minDanger = dangerCandidates.sort((a,b)=>a.diffPercent-b.diffPercent)[0];
        html += "<p class=\"margin-warn\">주의: 일부 투찰율은 하한가 미만입니다.</p>";
        html += "<ul><li>예: 투찰율 <b>" + formatPercent(minDanger.rate,3) +
                " %</b> → 하한가 대비 " + formatPercent(minDanger.diffPercent,3) +
                " % (낙찰 불가)</li></ul>";
      }

      if (bestHigh) {
        html += "<p>하한가보다 여유가 있는 구간에서 가장 낮은(그래도 높은) 후보는</p>";
        html += "<ul><li>투찰율 <b>" + formatPercent(bestHigh.rate,3) +
                " %</b> → 하한가 대비 " + formatPercent(bestHigh.diffPercent,3) +
                " % 입니다.</li></ul>";
      }

      html += "<p style=\"margin-top:6px;\">위 해석은 <b>단순 계산 기준</b>이며, 실제 낙찰 여부는 참여 업체 수, 기술점수, 기관 특성 등에 따라 달라질 수 있습니다.</p>";

      area.innerHTML = html;
    }

    function runMarginCalc() {
      if (!lastEstimated || !lastLimitPrice) {
        alert("먼저 기본 계산을 실행해 예정가격을 계산해 주세요.");
        return;
      }
      const marginRate   = Number(document.getElementById("inputMarginRate").value);
      const bookPrice    = parseNumber(document.getElementById("inputBookPrice").value);
      const commission   = Number(document.getElementById("inputCommission").value);

      if (!marginRate || isNaN(bookPrice) || isNaN(commission)) {
        alert("투찰율, 보고서 정가 합계, 커미션율을 모두 입력해 주세요.");
        return;
      }

      const bidPrice = lastEstimated * (marginRate / 100); // 부가세 제외 입찰금액
      // 기관에 청구하는 금액(부가세 포함)은 여기서 단순히 10% 부가세라고 가정하지 않고,
      // 이미 배정예산·예정가격 자체를 기준으로 본다고 보고, bidPrice를 그대로 사용.
      // 출판사 지급액: 정가 × (1 - 커미션율)
      const publisherPay = bookPrice * (1 - commission / 100);
      const margin = bidPrice - publisherPay;
      const marginRateReal = margin / bidPrice * 100;

      const div = document.getElementById("marginResult");
      div.innerHTML = "";

      const items = [
        { label:"선택 투찰율 기준 입찰금액 (부가세 제외 기준 근사)", value: formatCurrency(Math.round(bidPrice)) + " 원" },
        { label:"출판사 지급 예상액", value: formatCurrency(Math.round(publisherPay)) + " 원" },
        { label:"우리 예상 마진", value: formatCurrency(Math.round(margin)) + " 원 (" + formatPercent(marginRateReal,2) + " %)" }
      ];
      items.forEach(it => {
        const el = document.createElement("div");
        el.className = "summary-item";
        el.innerHTML =
          '<div class="summary-label">' + it.label + '</div>' +
          '<div class="summary-value">' + it.value + '</div>';
        div.appendChild(el);
      });

      const explain = document.createElement("div");
      explain.style.gridColumn = "1 / -1";
      let cls = marginRateReal < 5 ? "margin-warn" : "margin-ok";
      let msg = marginRateReal < 5
        ? "마진이 5% 미만입니다. 보고서 난이도·추가 업무를 고려하면 비추천 구간일 수 있습니다."
        : "마진이 어느 정도 확보되었습니다. 기술·서류 부담을 고려해 참여 여부를 판단하면 됩니다.";
      explain.innerHTML = '<div class="' + cls + '" style="margin-top:6px;">' + msg + '</div>';
      div.appendChild(explain);
    }

    document.getElementById("btnCalc").addEventListener("click", runCalc);
    document.getElementById("btnMargin").addEventListener("click", runMarginCalc);
  </script>
</body>
</html>
