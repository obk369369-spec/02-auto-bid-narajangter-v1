<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>2ë²ˆ ë„êµ¬ v1.0 â€“ ë‚˜ë¼ì¥í„° ì…ì°° ê³„ì‚°Â·ë¶„ì„ê¸°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 16px;
      margin-top: 24px;
      margin-bottom: 8px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    label {
      font-size: 13px;
      display: block;
      margin-bottom: 4px;
    }
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      transform: scale(1.1);
      margin-right: 4px;
    }
    .btn {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn.secondary {
      background: #4b5563;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .result-highlight {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      font-size: 13px;
    }
    .pill {
      background: #eef2ff;
      border-radius: 999px;
      padding: 6px 10px;
    }
    .pill.bad {
      background: #fee2e2;
      color: #b91c1c;
    }
    .pill.good {
      background: #dcfce7;
      color: #166534;
    }
    .pill.warn {
      background: #fef9c3;
      color: #854d0e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-right: 4px;
    }
    .badge.critical {
      background: #fee2e2;
      color: #b91c1c;
    }
    .badge.info {
      background: #e0f2fe;
      color: #0369a1;
    }
    .badge.safe {
      background: #dcfce7;
      color: #166534;
    }
    .badge.warn {
      background: #fef9c3;
      color: #854d0e;
    }
    .explain {
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-line;
    }
    canvas {
      background: #ffffff;
      border-radius: 8px;
      padding: 8px;
    }
    .sub {
      font-size: 11px;
      color: #6b7280;
    }
    .tag-row {
      font-size: 11px;
      margin-top: 4px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h1>2ë²ˆ ë„êµ¬ v1.0 â€“ ë‚˜ë¼ì¥í„° ì…ì°° ê³„ì‚°Â·ë¶„ì„ê¸°</h1>

  <!-- ì•ˆë‚´ ì¹´ë“œ -->
  <div class="card">
    <p class="sub">
      ğŸ”¹ ê³µê³  ìœ í˜•, ì¶”ì •ê°€ê²©, í•˜í•œìœ¨, ì •ê°€, ì»¤ë¯¸ì…˜ì„ ë„£ìœ¼ë©´<br />
      &nbsp;&nbsp;â†’ í•˜í•œê°€, ì—¬ëŸ¬ íˆ¬ì°°ìœ¨ í›„ë³´, ìš°ë¦¬ ë§ˆì§„, ê·¸ë˜í”„, í•´ì„ í…ìŠ¤íŠ¸ê¹Œì§€ í•œ ë²ˆì— ë³´ì—¬ì¤ë‹ˆë‹¤.<br />
      ğŸ”¹ ìˆ˜ì˜ì‹œë‹´ ê±´ì€ ìë™ìœ¼ë¡œ â€œì°¸ê°€ ë¶ˆê°€â€ë¡œ í‘œì‹œë˜ê³  ê³„ì‚°ì„ ë§‰ìŠµë‹ˆë‹¤.
    </p>
  </div>

  <!-- 1. ì…ë ¥ ì˜ì—­ -->
  <div class="card">
    <h2>1ë‹¨ê³„. ê³µê³  ê¸°ë³¸ ì •ë³´ ì…ë ¥</h2>
    <div class="grid">
      <div>
        <label>ê³µê³  ìœ í˜•</label>
        <select id="bidType">
          <option value="normal">ì¼ë°˜ì…ì°°</option>
          <option value="quote">ê²¬ì ìš”ì²­ê³µê³ </option>
          <option value="nego">ìˆ˜ì˜ì‹œë‹´ / ë‹¤ìê°„ìˆ˜ì˜ì‹œë‹´</option>
        </select>
      </div>
      <div>
        <label>ë°œì£¼ ê¸°ê´€ëª… (ì˜ˆ: í•œêµ­ìƒì‚°ê¸°ìˆ ì—°êµ¬ì›)</label>
        <input type="text" id="agencyName" placeholder="ê¸°ê´€ëª…ì„ ì ì–´ë‘ë©´ í•´ì„ì— ê°™ì´ í‘œì‹œë©ë‹ˆë‹¤." />
      </div>
      <div>
        <label>ê³µê³ ëª… (ê°„ë‹¨íˆ ë©”ëª¨ìš©)</label>
        <input type="text" id="noticeTitle" placeholder="ì˜ˆ: â—‹â—‹ ì‹œì¥ ë° ê¸°ìˆ ìë£Œ êµ¬ë§¤" />
      </div>
    </div>

    <h2>2ë‹¨ê³„. ìˆ«ì ì…ë ¥</h2>
    <div class="grid">
      <div>
        <label>ì¶”ì •ê°€ê²© / ê¸°ì´ˆê¸ˆì•¡ ê¸°ì¤€ (ì›)</label>
        <input type="number" id="basePrice" placeholder="ì˜ˆ: 20000000" />
      </div>
      <div>
        <label>ë‚™ì°°í•˜í•œìœ¨ (%)</label>
        <input type="number" id="lowerRate" step="0.001" value="87.745" />
      </div>
      <div>
        <label>ìš°ë¦¬ ë³´ê³ ì„œ ì •ê°€ (ì›, ë°œí–‰ì‚¬ ì •ê°€ ê¸°ì¤€)</label>
        <input type="number" id="listPrice" placeholder="ì˜ˆ: 12000000" />
      </div>
      <div>
        <label>ì»¤ë¯¸ì…˜ / í• ì¸ìœ¨ (%) (ë°œí–‰ì‚¬ì— ì§€ê¸‰ ë¹„ìœ¨)</label>
        <input type="number" id="commissionRate" step="0.1" value="20" />
      </div>
      <div>
        <label>ì¶”ì •ê°€ê²©ì˜ ë¶€ê°€ì„¸ ì²˜ë¦¬</label>
        <select id="vatType">
          <option value="included">ì¶”ì •ê°€ê²©ì— ë¶€ê°€ì„¸ í¬í•¨</option>
          <option value="excluded">ì¶”ì •ê°€ê²© + ë¶€ê°€ì„¸ ë³„ë„(10%)</option>
        </select>
      </div>
      <div>
        <label>íˆ¬ì°°ìœ¨ ë²”ìœ„ ì„¤ëª… (í‘œì‹œìš© í…ìŠ¤íŠ¸)</label>
        <input type="text" id="bidRange" value="í•˜í•œìœ¨ +0.05% ~ +1.00% (0.05 ë‹¨ìœ„)" />
      </div>
    </div>

    <h2>3ë‹¨ê³„. íˆ¬ì°° í›„ë³´ êµ¬ê°„ ì„¤ì •</h2>
    <div class="grid">
      <div>
        <label>í•˜í•œìœ¨ ëŒ€ë¹„ ìµœì†Œ ì—¬ìœ  (%)</label>
        <input type="number" id="extraStart" step="0.01" value="0.05" />
      </div>
      <div>
        <label>í•˜í•œìœ¨ ëŒ€ë¹„ ìµœëŒ€ ì—¬ìœ  (%)</label>
        <input type="number" id="extraEnd" step="0.01" value="1.00" />
      </div>
      <div>
        <label>ê°„ê²©(step, %) â€“ ì˜ˆ: 0.05</label>
        <input type="number" id="extraStep" step="0.01" value="0.05" />
      </div>
    </div>

    <div style="margin-top: 12px;">
      <button class="btn" id="calcBtn" onclick="runCalc()">ê³„ì‚°í•˜ê¸°</button>
      <button class="btn secondary" onclick="resetForm()">ì…ë ¥ ì´ˆê¸°í™”</button>
    </div>
    <div class="tag-row">
      <span class="tag">ë©´ì„¸ì‚¬ì—…ì ê°€ì •: ë§ˆì§„ = ì…ì°°ê°€ â€“ (ì •ê°€ Ã— (1â€“ì»¤ë¯¸ì…˜))</span>
      <span class="tag">ë¶€ê°€ì„¸ëŠ” ë°œì£¼ê¸°ê´€ ì„¸ê¸ˆìœ¼ë¡œ ë³´ê³  ë§ˆì§„ ê³„ì‚°ì—ì„œ ë¶„ë¦¬</span>
    </div>
  </div>

  <!-- 4. í•µì‹¬ ê²°ê³¼ -->
  <div class="card">
    <h2>4ë‹¨ê³„. í•µì‹¬ ìš”ì•½</h2>
    <div class="result-highlight" id="summaryArea">
      <span class="sub">ìœ„ì—ì„œ ê³µê³  ìœ í˜•ê³¼ ìˆ«ìë¥¼ ë„£ê³  â€œê³„ì‚°í•˜ê¸°â€ë¥¼ ëˆ„ë¥´ë©´ ìš”ì•½ì´ ë‚˜ì˜µë‹ˆë‹¤.</span>
    </div>
  </div>

  <!-- 5. íˆ¬ì°°ìœ¨ë³„ í‘œ -->
  <div class="card">
    <h2>5ë‹¨ê³„. íˆ¬ì°°ìœ¨ë³„ ì…ì°°ê°€Â·ë§ˆì§„ ìƒì„¸í‘œ</h2>
    <div class="sub">
      ê° í–‰ì€ í•˜ë‚˜ì˜ â€œíˆ¬ì°° ì „ëµâ€ì…ë‹ˆë‹¤. ë¶‰ì€ ìƒ‰ ê²½ê³ ëŠ” í•˜í•œê°€ ë¯¸ë§Œ(íƒˆë½ ìœ„í—˜), ë…¸ë€ìƒ‰ì€ ê·¼ì ‘(ì£¼ì˜), ì´ˆë¡ìƒ‰ì€ ë¹„êµì  ì•ˆì „ êµ¬ê°„ì…ë‹ˆë‹¤.
    </div>
    <div id="tableArea"></div>
  </div>

  <!-- 6. ê·¸ë˜í”„ -->
  <div class="card">
    <h2>6ë‹¨ê³„. ê·¸ë˜í”„ â€“ ì…ì°°ê°€Â·í•˜í•œê°€Â·ìš°ë¦¬ ë§ˆì§„</h2>
    <div class="sub">íŒŒë€ì„ : ì…ì°°ê°€ / ë¹¨ê°„ì„ : í•˜í•œê°€ ìˆ˜í‰ì„  / ì´ˆë¡ì„ : ìš°ë¦¬ ë§ˆì§„ (ìš°ì¸¡ ì¶•)</div>
    <canvas id="chartCanvas" height="220"></canvas>
  </div>

  <!-- 7. ìë™ í•´ì„ í…ìŠ¤íŠ¸ -->
  <div class="card">
    <h2>7ë‹¨ê³„. ìë™ í•´ì„ í…ìŠ¤íŠ¸ (í•™ìŠµìš© ì„¤ëª…)</h2>
    <div id="explainArea" class="explain">
      ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ«ìë¥¼ ë„£ê³  ê³„ì‚°ì„ ëŒë¦¬ë©´,<br />
      â€¢ í•˜í•œê°€ê°€ ì–´ë””ì¸ì§€<br />
      â€¢ ì–´ëŠ íˆ¬ì°°ìœ¨ êµ¬ê°„ì´ â€œë„ˆë¬´ ë‚®ì§€ë„, ë„ˆë¬´ ë†’ì§€ë„ ì•Šì€ì§€â€<br />
      â€¢ ìš°ë¦¬ì—ê²Œ ë‚¨ëŠ” ì˜ˆìƒ ë§ˆì§„ì´ ì–´ëŠ ì •ë„ì¸ì§€<br />
      ê¸€ë¡œ ì •ë¦¬í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    </div>
  </div>

  <!-- 8. ì˜ˆë¹„ê°€ê²© ì‹œë®¬ë ˆì´ì…˜ -->
  <div class="card">
    <h2>8ë‹¨ê³„. ì˜ˆë¹„ê°€ê²© 15ê°œ(Â±2%) & 4ê°œ ì¶”ì²¨ í‰ê· </h2>
    <div class="sub">
      ì‹¤ì œ ë‚˜ë¼ì¥í„° êµ¬ì¡°ë¥¼ ë‹¨ìˆœ ëª¨ë¸ë¡œ í‘œí˜„í•œ ê²ƒì…ë‹ˆë‹¤. (Â±2% êµ¬ê°„ì—ì„œ 15ê°œ ë§Œë“¤ê³ , ê·¸ ì¤‘ 4ê°œë¥¼ ë½‘ì•„ í‰ê· )
    </div>
    <div id="prePriceArea" class="explain"></div>
  </div>

  <script>
    let chart;

    function formatKRW(value) {
      if (isNaN(value)) return '-';
      return value.toLocaleString('ko-KR') + 'ì›';
    }

    function resetForm() {
      document.getElementById('bidType').value = 'normal';
      document.getElementById('agencyName').value = '';
      document.getElementById('noticeTitle').value = '';
      document.getElementById('basePrice').value = '';
      document.getElementById('lowerRate').value = 87.745;
      document.getElementById('listPrice').value = '';
      document.getElementById('commissionRate').value = 20;
      document.getElementById('vatType').value = 'included';
      document.getElementById('extraStart').value = 0.05;
      document.getElementById('extraEnd').value = 1.0;
      document.getElementById('extraStep').value = 0.05;
      document.getElementById('summaryArea').innerHTML =
        '<span class="sub">ìœ„ì—ì„œ ê³µê³  ìœ í˜•ê³¼ ìˆ«ìë¥¼ ë„£ê³  â€œê³„ì‚°í•˜ê¸°â€ë¥¼ ëˆ„ë¥´ë©´ ìš”ì•½ì´ ë‚˜ì˜µë‹ˆë‹¤.</span>';
      document.getElementById('tableArea').innerHTML = '';
      document.getElementById('explainArea').textContent =
        'ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìˆ«ìë¥¼ ë„£ê³  ê³„ì‚°ì„ ëŒë¦¬ë©´,\nâ€¢ í•˜í•œê°€ê°€ ì–´ë””ì¸ì§€\nâ€¢ ì–´ëŠ íˆ¬ì°°ìœ¨ êµ¬ê°„ì´ â€œë„ˆë¬´ ë‚®ì§€ë„, ë„ˆë¬´ ë†’ì§€ë„ ì•Šì€ì§€â€\nâ€¢ ìš°ë¦¬ì—ê²Œ ë‚¨ëŠ” ì˜ˆìƒ ë§ˆì§„ì´ ì–´ëŠ ì •ë„ì¸ì§€\nê¸€ë¡œ ì •ë¦¬í•´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.';
      document.getElementById('prePriceArea').textContent = '';
      if (chart) chart.destroy();
    }

    function runCalc() {
      const bidType = document.getElementById('bidType').value;
      const agencyName = document.getElementById('agencyName').value.trim();
      const noticeTitle = document.getElementById('noticeTitle').value.trim();
      const basePrice = Number(document.getElementById('basePrice').value);
      const lowerRate = Number(document.getElementById('lowerRate').value);
      const listPrice = Number(document.getElementById('listPrice').value);
      const commissionRate = Number(document.getElementById('commissionRate').value);
      const vatType = document.getElementById('vatType').value;
      const extraStart = Number(document.getElementById('extraStart').value);
      const extraEnd = Number(document.getElementById('extraEnd').value);
      const extraStep = Number(document.getElementById('extraStep').value);

      const summaryArea = document.getElementById('summaryArea');
      const tableArea = document.getElementById('tableArea');
      const explainArea = document.getElementById('explainArea');
      const preArea = document.getElementById('prePriceArea');

      // ìˆ˜ì˜ì‹œë‹´ ì°¨ë‹¨
      if (bidType === 'nego') {
        summaryArea.innerHTML = `
          <span class="pill bad"><b>ìˆ˜ì˜ì‹œë‹´ / ë‹¤ìê°„ìˆ˜ì˜ì‹œë‹´</b> ê³µê³ ëŠ” ì •ë³´ ê³µê°œìš©ì´ë©°, ê³„ì•½ëŒ€ìƒìê°€ ì•„ë‹Œ ì—…ì²´ëŠ” ì°¸ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
          <span class="pill">ì´ ê±´ì€ ê³„ì‚°Â·íˆ¬ì°° ëŒ€ìƒì—ì„œ ì œì™¸í•´ì•¼ í•©ë‹ˆë‹¤.</span>
        `;
        tableArea.innerHTML = '';
        explainArea.textContent =
          'ì´ ê³µê³ ëŠ” ìˆ˜ì˜ì‹œë‹´/ë‹¤ìê°„ìˆ˜ì˜ì‹œë‹´ ìœ í˜•ìœ¼ë¡œ ì¸ì‹ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n' +
          'Â· ë‚˜ë¼ì¥í„° ì•ˆë‚´ì²˜ëŸ¼ â€œê³„ì•½ëŒ€ìƒìê°€ ì•„ë‹Œ ì—…ì²´ëŠ” ì°¸ê°€í•  ìˆ˜ ì—†ìŒâ€ìœ¼ë¡œ ë³´ì•„,\n' +
          '  WICê°€ ìƒˆë¡œ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ê±´ì´ ì•„ë‹ˆë¼ê³  íŒë‹¨í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.\n\n' +
          'ë”°ë¼ì„œ ì´ ë„êµ¬ì—ì„œëŠ” ì…ì°°ê°€Â·ë§ˆì§„ ê³„ì‚°ì„ í•˜ì§€ ì•Šê³ , í™”ë©´ì—ì„œë§Œ â€œì°¸ê°€ ë¶ˆê°€â€ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.';
        preArea.textContent = '';
        if (chart) chart.destroy();
        return;
      }

      if (!basePrice || !lowerRate) {
        alert('ì¶”ì •ê°€ê²©(ë˜ëŠ” ê¸°ì´ˆê¸ˆì•¡)ê³¼ ë‚™ì°°í•˜í•œìœ¨ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      // ë¶€ê°€ì„¸ ì²˜ë¦¬ (ë‹¨ìˆœ 10% ê°€ì •)
      let effectiveBase = basePrice;
      if (vatType === 'excluded') {
        effectiveBase = basePrice * 1.1;
      }

      const lowerLimit = effectiveBase * (lowerRate / 100);

      // íˆ¬ì°°ìœ¨ ë²”ìœ„ ìƒì„±
      const rows = [];
      const eps = 1e-9;
      for (let extra = extraStart; extra <= extraEnd + eps; extra += extraStep) {
        const rate = lowerRate + extra; // %
        const bidPrice = effectiveBase * (rate / 100);
        const diffFromLower = bidPrice - lowerLimit;
        const diffRatio = (bidPrice / lowerLimit - 1) * 100;

        let margin = NaN;
        if (listPrice && commissionRate >= 0) {
          const costToUs = listPrice * (1 - commissionRate / 100);
          margin = bidPrice - costToUs; // ë©´ì„¸ ê°€ì •
        }

        rows.push({ rate, bidPrice, diffFromLower, diffRatio, margin });
      }

      // ì„ì‹œ ì¶”ì²œ: í•˜í•œê°€ë³´ë‹¤ ì¡°ê¸ˆ ìœ„ì´ë©´ì„œ ë§ˆì§„ì´ ì–‘ìˆ˜ì¸ ì²« êµ¬ê°„
      let recommended = rows.find(r => r.diffFromLower > 0 && (isNaN(r.margin) || r.margin > 0));
      if (!recommended) {
        recommended = rows[Math.floor(rows.length / 2)];
      }

      const safeBadgeClass = recommended.diffFromLower > 0 ? 'good' : 'bad';
      const typeLabel =
        bidType === 'normal' ? 'ì¼ë°˜ì…ì°°' :
        bidType === 'quote' ? 'ê²¬ì ìš”ì²­ê³µê³ ' : 'ìˆ˜ì˜ì‹œë‹´';

      summaryArea.innerHTML = `
        <span class="pill">
          ìœ í˜•: <b>${typeLabel}</b>
          ${agencyName ? ' / ê¸°ê´€: <b>' + agencyName + '</b>' : ''}
        </span>
        ${noticeTitle ? '<span class="pill">ê³µê³ ëª…: <b>' + noticeTitle + '</b></span>' : ''}
        <span class="pill">í•˜í•œê°€: <b>${formatKRW(lowerLimit)}</b> (${lowerRate.toFixed(3)}%)</span>
        <span class="pill ${safeBadgeClass}">
          ì„ì‹œ ì¶”ì²œ íˆ¬ì°°ìœ¨: <b>${recommended.rate.toFixed(3)}%</b>,
          ì…ì°°ê°€: <b>${formatKRW(recommended.bidPrice)}</b>
        </span>
        ${!isNaN(recommended.margin) ? `
        <span class="pill">
          ì´ íˆ¬ì°°ì—ì„œ ì˜ˆìƒ ë§ˆì§„: <b>${formatKRW(recommended.margin)}</b>
        </span>` : ''}
      `;

      // í‘œ
      let html = `
        <table>
          <thead>
            <tr>
              <th>íˆ¬ì°°ìœ¨(%)</th>
              <th>ì…ì°°ê°€</th>
              <th>í•˜í•œê°€ ëŒ€ë¹„ ì°¨ì´</th>
              <th>í•˜í•œê°€ ëŒ€ë¹„ ë¹„ìœ¨</th>
              <th>ì˜ˆìƒ ë§ˆì§„</th>
              <th>ë¹„ê³ </th>
            </tr>
          </thead>
          <tbody>
      `;
      rows.forEach(r => {
        const isBelow = r.bidPrice < lowerLimit;
        const gapPercent = r.diffRatio;
        let note, className;
        if (isBelow) {
          note = '<span class="badge critical">í•˜í•œê°€ ë¯¸ë§Œ (íƒˆë½ ìœ„í—˜)</span>';
          className = 'critical';
        } else if (gapPercent >= 0 && gapPercent < 0.1) {
          note = '<span class="badge warn">í•˜í•œê°€ ê·¼ì ‘ (ì£¼ì˜)</span>';
          className = 'warn';
        } else {
          note = '<span class="badge safe">ì•ˆì „ êµ¬ê°„</span>';
          className = 'safe';
        }
        html += `
          <tr>
            <td>${r.rate.toFixed(3)}</td>
            <td>${formatKRW(r.bidPrice)}</td>
            <td>${formatKRW(r.diffFromLower)}</td>
            <td>${r.diffRatio.toFixed(3)}%</td>
            <td>${isNaN(r.margin) ? '-' : formatKRW(r.margin)}</td>
            <td>${note}</td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      tableArea.innerHTML = html;

      // ê·¸ë˜í”„
      const labels = rows.map(r => r.rate.toFixed(3));
      const dataBid = rows.map(r => Math.round(r.bidPrice));
      const dataLower = rows.map(() => Math.round(lowerLimit));
      const dataMargin = rows.map(r => isNaN(r.margin) ? null : Math.round(r.margin));

      const ctx = document.getElementById('chartCanvas').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'ì…ì°°ê°€',
              data: dataBid,
              borderWidth: 2,
              tension: 0.2
            },
            {
              label: 'í•˜í•œê°€ (ìˆ˜í‰ì„ )',
              data: dataLower,
              borderWidth: 1,
              borderDash: [4, 4],
              tension: 0
            },
            {
              label: 'ìš°ë¦¬ ë§ˆì§„',
              data: dataMargin,
              borderWidth: 2,
              tension: 0.2,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          interaction: { mode: 'index', intersect: false },
          stacked: false,
          plugins: {
            legend: { labels: { font: { size: 11 } } }
          },
          scales: {
            y: {
              type: 'linear',
              position: 'left',
              ticks: { font: { size: 10 } }
            },
            y1: {
              type: 'linear',
              position: 'right',
              ticks: { font: { size: 10 } },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      // ìë™ í•´ì„ í…ìŠ¤íŠ¸
      const bestSafe = rows.find(
        r => r.diffFromLower > 0 && (isNaN(r.margin) || r.margin > 0)
      ) || recommended;

      const marginText = isNaN(bestSafe.margin)
        ? 'ì •ê°€Â·ì»¤ë¯¸ì…˜ ì •ë³´ê°€ ì—†ì–´ì„œ ë§ˆì§„ ë¶„ì„ì€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤.'
        : `ì´ êµ¬ê°„ì—ì„œ ì˜ˆìƒ ë§ˆì§„ì€ ì•½ ${formatKRW(bestSafe.margin)} ìˆ˜ì¤€ì…ë‹ˆë‹¤. (ë©´ì„¸ì‚¬ì—…ì ê°€ì •)`;

      const typeExplain =
        bidType === 'normal'
          ? 'ì´ ê±´ì€ ì¼ë°˜ì…ì°°ë¡œ íŒë‹¨ë˜ë©°, í†µìƒì ì¸ ë‚™ì°°í•˜í•œìœ¨ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.'
          : 'ì´ ê±´ì€ ê²¬ì ìš”ì²­ê³µê³ ë¡œ, ê²½ìŸ ê°•ë„ê°€ ì¼ë°˜ì…ì°°ë³´ë‹¤ ë‚®ì„ ìˆ˜ ìˆì§€ë§Œ, ê¸°ë³¸ ì›ë¦¬ëŠ” ë™ì¼í•œ í•˜í•œê°€ êµ¬ì¡°ë¥¼ ë”°ë¦…ë‹ˆë‹¤.';

      explainArea.textContent =
`[1] í•˜í•œê°€ ìœ„ì¹˜
Â· í•˜í•œê°€ëŠ” ${formatKRW(lowerLimit)} (íˆ¬ì°°ìœ¨ ${lowerRate.toFixed(3)}%) ì…ë‹ˆë‹¤.
Â· ì´ ì„  ì•„ë˜ë¡œ ë–¨ì–´ì§€ëŠ” ìˆœê°„, í˜•ì‹ì ìœ¼ë¡œëŠ” ë°”ë¡œ íƒˆë½ ìœ„í—˜ êµ¬ê°„ì— ë“¤ì–´ê°‘ë‹ˆë‹¤.

[2] ì¶”ì²œ êµ¬ê°„ í•´ì„
Â· í˜„ì¬ ì„¤ì •ì—ì„œ ë¹„êµì  ê· í˜•ì´ ì¢‹ì•„ ë³´ì´ëŠ” ì§€ì ì€ íˆ¬ì°°ìœ¨ ${bestSafe.rate.toFixed(3)}% ë¶€ê·¼ì…ë‹ˆë‹¤.
Â· ì´ ë•Œ ì…ì°°ê°€ëŠ” ì•½ ${formatKRW(bestSafe.bidPrice)} ë¡œ, í•˜í•œê°€ë³´ë‹¤ ì•½ ${formatKRW(bestSafe.diffFromLower)} (${bestSafe.diffRatio.toFixed(3)}%) ìœ„ì— ìˆìŠµë‹ˆë‹¤.
Â· ë„ˆë¬´ ë‚®ì§€ë„, ë„ˆë¬´ ë†’ì§€ë„ ì•Šì€ â€œì™„ì¶© êµ¬ê°„â€ì„ í™•ë³´í•˜ëŠ” ê²ƒì´ ëª©ì ì…ë‹ˆë‹¤.

[3] ìš°ë¦¬ ì‚¬ì—…ì¥ ë§ˆì§„ ê´€ì 
Â· ${marginText}
Â· ë°œí–‰ì‚¬ ì •ê°€: ${listPrice ? formatKRW(listPrice) : 'ì…ë ¥ ì—†ìŒ'}
Â· ì»¤ë¯¸ì…˜(í• ì¸ìœ¨): ${isNaN(commissionRate) ? '-' : commissionRate.toFixed(1) + '%'}
â†’ ì…ì°°ê°€ â€“ (ì •ê°€ Ã— (1â€“ì»¤ë¯¸ì…˜)) êµ¬ì¡°ë¡œ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤.

[4] ì…ì°° ìœ í˜• ê´€ì 
Â· ${typeExplain}
${agencyName ? 'Â· ê¸°ê´€: ' + agencyName + ' / ' : ''}${noticeTitle ? 'ê³µê³ ëª…: ' + noticeTitle : ''}

[5] ê·¸ë˜í”„ ì½ëŠ” ë²•
Â· íŒŒë€ì„ (ì…ì°°ê°€)ì´ ë¹¨ê°„ì„ (í•˜í•œê°€)ë³´ë‹¤ ì•„ë˜ë¡œ ë‚´ë ¤ê°€ëŠ” êµ¬ê°„ì€ ì ˆëŒ€ í”¼í•´ì•¼ í•˜ëŠ” êµ¬ê°„ì…ë‹ˆë‹¤.
Â· íŒŒë€ì„ ì´ ë¹¨ê°„ì„ ì„ ì‚´ì§ ìœ„ì—ì„œ ë”°ë¼ê°€ë©´ì„œ, ì´ˆë¡ì„ (ìš°ë¦¬ ë§ˆì§„)ì´ ì¶©ë¶„íˆ í”ŒëŸ¬ìŠ¤ì¸ êµ¬ê°„ì´ â€œí˜„ì‹¤ì ì¸ í›„ë³´â€ì…ë‹ˆë‹¤.
Â· í‘œì™€ ê·¸ë˜í”„ë¥¼ ê°™ì´ ë³´ë©´ì„œ, ì‹¤ì œ íˆ¬ì°°ìœ¨ì„ ê²°ì •í•˜ë©´ ë©ë‹ˆë‹¤.
`;

      // ì˜ˆë¹„ê°€ê²© 15ê°œ ì‹œë®¬ë ˆì´ì…˜
      const prePrices = [];
      const minFactor = 0.98;
      const maxFactor = 1.02;
      for (let i = 0; i < 15; i++) {
        const factor = minFactor + (maxFactor - minFactor) * (i / 14);
        prePrices.push(effectiveBase * factor);
      }
      const chosen = [];
      for (let i = 0; i < 4; i++) {
        const idx = Math.floor(Math.random() * prePrices.length);
        chosen.push(prePrices[idx]);
      }
      const avg = chosen.reduce((a, b) => a + b, 0) / chosen.length;

      let preText =
`[ì˜ˆë¹„ê°€ê²© 15ê°œ (Â±2%) ë‹¨ìˆœ ì‹œë®¬ë ˆì´ì…˜]

Â· ì˜ˆë¹„ê°€ê²© ë²”ìœ„: ì•½ ${formatKRW(prePrices[0])} ~ ${formatKRW(prePrices[prePrices.length - 1])}
Â· ì„ì˜ë¡œ ë½‘íŒ 4ê°œ ì˜ˆë¹„ê°€ê²©(ì˜ˆì‹œ):
  - ${chosen.map(v => formatKRW(v)).join(', ')}
Â· ì´ 4ê°œì˜ í‰ê· (ì„ì‹œ ì˜ˆì •ê°€ê²©): ${formatKRW(avg)}

â†’ ì‹¤ì œ ë‚˜ë¼ì¥í„°ì—ì„œëŠ” ì´ëŸ° êµ¬ì¡°ë¡œ ì˜ˆì •ê°€ê²©ì´ ì •í•´ì§€ê³ ,
   â€œë‚™ì°°í•˜í•œìœ¨ Ã— ì˜ˆì •ê°€ê²© = í•˜í•œê°€â€ê°€ ë©ë‹ˆë‹¤.
   ì—¬ê¸°ì„œëŠ” êµ¬ì¡°ë¥¼ ì´í•´í•˜ê¸° ìœ„í•œ í•™ìŠµìš© ëª¨ë¸ì…ë‹ˆë‹¤.`;
      preArea.textContent = preText;
    }
  </script>
</body>
</html>
